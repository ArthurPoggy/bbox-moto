<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detector de Chassi - YOLO</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="page">
      <header>
        <div>
          <div class="title">Detector de Chassi</div>
          <p style="margin: 6px 0 0; color: var(--muted)">
            Envie uma foto e veja a caixa predita pelo modelo.
          </p>
        </div>
        <div class="badge" id="badge">Carregando modelo...</div>
      </header>

      <div class="grid">
        <section class="panel">
          <h2>Upload</h2>
          <p>Escolha qualquer imagem (JPG/PNG). O processamento acontece em CPU.</p>
          <form id="upload-form" class="upload-area">
            <div class="input-row">
              <input type="file" id="image-input" name="file" accept="image/*" required />
              <button class="btn" type="submit" id="send-btn">Rodar modelo</button>
            </div>
            <div class="status" id="status">Pronto para receber uma imagem.</div>
          </form>
          <div class="preview" id="preview-box">
            <img id="preview-img" alt="Pr√©-visualiza√ß√£o" />
            <div class="loader" id="preview-loader"></div>
          </div>
        </section>

        <section class="panel">
          <h2>Resultado</h2>
          <div class="result" id="result-box">
            <img id="result-img" alt="Resultado" />
            <div class="loader" id="result-loader"></div>
          </div>
          <div class="meta">
            <span>‚è±Ô∏è <span id="inference-time">--</span></span>
            <span>üéØ <span id="detections">--</span></span>
          </div>
        </section>
      </div>
    </div>

    <script>
      const form = document.getElementById("upload-form");
      const input = document.getElementById("image-input");
      const statusEl = document.getElementById("status");
      const previewImg = document.getElementById("preview-img");
      const resultImg = document.getElementById("result-img");
      const inferenceEl = document.getElementById("inference-time");
      const detectionsEl = document.getElementById("detections");
      const badge = document.getElementById("badge");
      const sendBtn = document.getElementById("send-btn");
      const previewLoader = document.getElementById("preview-loader");
      const resultLoader = document.getElementById("result-loader");

      function setStatus(message, tone = "muted") {
        statusEl.textContent = message;
        statusEl.dataset.tone = tone;
      }

      function toggleLoading(isLoading) {
        sendBtn.disabled = isLoading;
        resultLoader.classList.toggle("active", isLoading);
      }

      function loadPreview(file) {
        if (!file) return;
        previewLoader.classList.add("active");
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          previewLoader.classList.remove("active");
        };
        reader.readAsDataURL(file);
      }

      async function pingHealth() {
        try {
          const res = await fetch("/health");
          if (!res.ok) throw new Error();
          const data = await res.json();
          badge.textContent = "Modelo pronto";
          badge.style.background = "rgba(34, 197, 94, 0.12)";
          badge.style.color = "#22c55e";
          setStatus(`Modelo carregado em ${data.model_path}`, "ok");
        } catch {
          badge.textContent = "Modelo indispon√≠vel";
          badge.style.background = "rgba(239, 68, 68, 0.12)";
          badge.style.color = "#ef4444";
          setStatus("N√£o foi poss√≠vel confirmar o carregamento do modelo.", "error");
        }
      }

      input.addEventListener("change", () => {
        if (input.files.length) {
          loadPreview(input.files[0]);
          setStatus("Imagem carregada. Clique em Rodar modelo.");
        }
      });

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!input.files.length) {
          setStatus("Selecione uma imagem primeiro.", "error");
          return;
        }

        const formData = new FormData();
        formData.append("file", input.files[0]);

        toggleLoading(true);
        setStatus("Processando imagem...");
        inferenceEl.textContent = "--";
        detectionsEl.textContent = "--";

        try {
          const response = await fetch("/predict", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || "Falha ao rodar o modelo.");
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          resultImg.src = url;

          const inferenceTime = response.headers.get("X-Inference-Time");
          const detections = response.headers.get("X-Detections");

          inferenceEl.textContent = inferenceTime ? `${inferenceTime}s` : "--";
          detectionsEl.textContent = detections ?? "--";
          setStatus("Predi√ß√£o finalizada.", "ok");
        } catch (err) {
          console.error(err);
          setStatus(err.message || "Erro ao processar a imagem.", "error");
        } finally {
          toggleLoading(false);
        }
      });

      pingHealth();
    </script>
  </body>
</html>
